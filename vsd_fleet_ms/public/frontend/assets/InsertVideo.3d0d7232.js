var g=(i,e,t)=>new Promise((p,s)=>{var l=o=>{try{a(t.next(o))}catch(d){s(d)}},r=o=>{try{a(t.throw(o))}catch(d){s(d)}},a=o=>o.done?p(o.value):Promise.resolve(o.value).then(l,r);a((t=t.apply(i,e)).next())});import{_ as D,d as f,e as _,g as F,C as y,D as k,E as C,H as S,J as x,B as m,h as u,k as n,L as c,t as N,m as U,j as v,F as E}from"./index.33f7111f.js";class A{constructor(){this.listeners={},this.failed=!1}on(e,t){this.listeners[e]=this.listeners[e]||[],this.listeners[e].push(t)}trigger(e,t){(this.listeners[e]||[]).forEach(s=>{s.call(this,t)})}upload(e,t){return new Promise((p,s)=>{let l=new XMLHttpRequest;l.upload.addEventListener("loadstart",()=>{this.trigger("start")}),l.upload.addEventListener("progress",o=>{o.lengthComputable&&this.trigger("progress",{uploaded:o.loaded,total:o.total})}),l.upload.addEventListener("load",()=>{this.trigger("finish")}),l.addEventListener("error",()=>{this.trigger("error"),s()}),l.onreadystatechange=()=>{if(l.readyState==XMLHttpRequest.DONE){let o;if(l.status===200){let d=null;try{d=JSON.parse(l.responseText)}catch(V){d=l.responseText}let h=d.message||d;p(h)}else if(l.status===403)o=JSON.parse(l.responseText);else{this.failed=!0;try{o=JSON.parse(l.responseText)}catch(d){}}o&&o.exc&&console.error(JSON.parse(o.exc)[0]),s(o)}};const r=t.upload_endpoint||"/api/method/upload_file";l.open("POST",r,!0),l.setRequestHeader("Accept","application/json"),window.csrf_token&&window.csrf_token!=="{{ csrf_token }}"&&l.setRequestHeader("X-Frappe-CSRF-Token",window.csrf_token);let a=new FormData;e&&a.append("file",e,e.name),a.append("is_private",t.private?"1":"0"),a.append("folder",t.folder||"Home"),t.file_url&&a.append("file_url",t.file_url),t.doctype&&a.append("doctype",t.doctype),t.docname&&a.append("docname",t.docname),t.fieldname&&a.append("fieldname",t.fieldname),t.method&&a.append("method",t.method),t.type&&a.append("type",t.type),l.send(a)})}}const L={name:"FileUploader",props:["fileTypes","uploadArgs","validateFile"],data(){return{uploader:null,uploading:!1,uploaded:0,error:null,message:"",total:0,file:null,finishedUploading:!1}},computed:{progress(){let i=Math.floor(this.uploaded/this.total*100);return isNaN(i)?0:i},success(){return this.finishedUploading&&!this.error}},methods:{openFileSelector(i){i&&(this.$refs.input.accept=i),this.$refs.input.click()},onFileAdd(i){return g(this,null,function*(){if(this.error=null,this.file=i.target.files[0],this.file&&this.validateFile)try{let e=yield this.validateFile(this.file);e&&(this.error=e)}catch(e){this.error=e}this.error||this.uploadFile(this.file)})},uploadFile(i){return g(this,null,function*(){this.error=null,this.uploaded=0,this.total=0,this.uploader=new A,this.uploader.on("start",()=>{this.uploading=!0}),this.uploader.on("progress",e=>{this.uploaded=e.uploaded,this.total=e.total}),this.uploader.on("error",()=>{this.uploading=!1,this.error="Error Uploading File"}),this.uploader.on("finish",()=>{this.uploading=!1,this.finishedUploading=!0}),this.uploader.upload(i,this.uploadArgs||{}).then(e=>{this.$emit("success",e)}).catch(e=>{this.uploading=!1;let t="Error Uploading File";e!=null&&e._server_messages?t=JSON.parse(JSON.parse(e._server_messages)[0]).message:e!=null&&e.exc&&(t=JSON.parse(e.exc)[0].split(`
`).slice(-2,-1)[0]),this.error=t,this.$emit("failure",e)})})}}},O=["accept"];function T(i,e,t,p,s,l){return f(),_("div",null,[F("input",{ref:"input",type:"file",accept:t.fileTypes,class:"hidden",onChange:e[0]||(e[0]=(...r)=>l.onFileAdd&&l.onFileAdd(...r))},null,40,O),y(i.$slots,"default",k(C({file:s.file,uploading:s.uploading,progress:l.progress,uploaded:s.uploaded,message:s.message,error:s.error,total:s.total,success:l.success,openFileSelector:l.openFileSelector})))])}var B=D(L,[["render",T]]);const J={name:"InsertImage",props:["editor"],expose:["openDialog"],data(){return{addVideoDialog:{url:"",file:null,show:!1}}},components:{Button:S,Dialog:x,FileUploader:B},methods:{openDialog(){this.addVideoDialog.show=!0},onVideoSelect(i){let e=i.target.files[0];!e||(this.addVideoDialog.file=e)},addVideo(i){this.editor.chain().focus().insertContent(`<video src="${i}"></video>`).run(),this.reset()},reset(){this.addVideoDialog=this.$options.data().addVideoDialog}}},H={class:"flex items-center space-x-2"},R=["src"];function q(i,e,t,p,s,l){const r=m("Button"),a=m("FileUploader"),o=m("Dialog");return f(),_(E,null,[y(i.$slots,"default",k(C({onClick:l.openDialog}))),u(o,{options:{title:"Add Video"},modelValue:s.addVideoDialog.show,"onUpdate:modelValue":e[2]||(e[2]=d=>s.addVideoDialog.show=d),onAfterLeave:l.reset},{"body-content":n(()=>[u(a,{"file-types":"video/*",onSuccess:e[0]||(e[0]=d=>s.addVideoDialog.url=d.file_url)},{default:n(({file:d,progress:h,uploading:V,openFileSelector:w})=>[F("div",H,[u(r,{onClick:w},{default:n(()=>[c(N(V?`Uploading ${h}%`:s.addVideoDialog.url?"Change Video":"Upload Video"),1)]),_:2},1032,["onClick"]),s.addVideoDialog.url?(f(),U(r,{key:0,onClick:()=>{s.addVideoDialog.url=null,s.addVideoDialog.file=null}},{default:n(()=>[c(" Remove ")]),_:2},1032,["onClick"])):v("",!0)])]),_:1}),s.addVideoDialog.url?(f(),_("video",{key:0,src:s.addVideoDialog.url,class:"mt-2 w-full rounded-lg",type:"video/mp4",controls:""},null,8,R)):v("",!0)]),actions:n(()=>[u(r,{variant:"solid",onClick:e[1]||(e[1]=d=>l.addVideo(s.addVideoDialog.url))},{default:n(()=>[c(" Insert Video ")]),_:1}),u(r,{onClick:l.reset},{default:n(()=>[c("Cancel")]),_:1},8,["onClick"])]),_:1},8,["modelValue","onAfterLeave"])],64)}var P=D(J,[["render",q]]);export{P as default};
